# Drevo — Семейное генеалогическое приложение

## О проекте

Drevo («Древо») — приложение для просмотра, поиска и исследования семейного генеалогического древа. Позволяет хранить и визуализировать родственные связи, просматривать фотографии и биографии членов семьи, отслеживать важные даты и события. Существует Android-приложение; планируется создание веб-версии.

## Функциональные возможности

### 1. Главный экран (Сплеш)

- Отображение текущей даты (день недели, число, месяц, год)
- Версия приложения и количество людей в базе
- Две главные кнопки: «Фамильное древо» и «Ближайшие события»
- Поле поиска с голосовым вводом
- Ссылка на Telegram-канал семьи
- Сворачиваемая карточка «О приложении» (описание, благодарности, дата сбора данных)
- Сворачиваемая карточка «Информация» (описание функций зелёных кнопок)
- Меню настроек

### 2. Просмотр карточки человека (Древо)

**Основная информация:**
- ФИО, ID, возраст (автоматический расчёт)
- Фото-слайдшоу с анимацией GATE (несколько фото на человека)
- Индикаторы событий текущего дня:
  - Торт — день рождения
  - Огонь — день памяти (годовщина смерти)
  - Кольца — годовщина свадьбы
  - Lottie-анимация конфетти на день рождения живого человека

**Родственные связи:**
- Родители (отец, мать) с фото и количеством детей
- До 4 супругов с фотографиями
- Горизонтальная прокручиваемая лента детей с фотографиями
- Клик по любому родственнику — переход на его карточку

**Навигация:**
- Стрелки влево/вправо — последовательная навигация по базе
- Долгое нажатие на стрелку — переход в начало/конец базы
- Режим «зелёных кнопок» — навигация по 20 последним просмотренным
- История просмотров (до 20 человек)
- Быстрый переход по ID (диалог ввода)

**FAB-меню (плавающее меню с анимацией):**
- Найти близких родственников
- Избранное (12 слотов)
- Проверка родства между двумя людьми
- Слайд-шоу (старт/пауза)
- Дерево поколений

**Звёздочка избранного** — добавление/удаление из избранного

### 3. Подробный профиль (Анкета)

- ФИО, ID
- Дата рождения + знак зодиака
- Дата смерти (если умер)
- Возраст / продолжительность жизни
- Адрес проживания
- Место рождения, место смерти
- Имена родителей, супругов, детей
- Фото-слайдшоу с анимацией ZOOM_OUT
- Биографическая информация:
  - Открытая (доступна всем)
  - Закрытая (доступ по паролю "7771", через long-press на имени)
- Копирование биографии в буфер обмена

### 4. Дерево поколений

- Визуализация до 13 поколений предков
- Визуализация до 13 поколений потомков
- Цветовая кодировка: зелёные кружки — живые, красные — умершие
- Фиолетовая подсветка текущего человека
- Статистика: общее количество людей, количество поколений
- Отображение имён и ID
- FlexboxLayout для гибкого размещения элементов

### 5. Поиск

- Полнотекстовый поиск по нескольким полям:
  - ID
  - Имя и фамилия
  - Адрес и место рождения
  - Дата рождения (включая поиск по названию месяца: «январь» → .01.)
  - Дата смерти
  - Дата свадьбы
- Голосовой ввод (speech-to-text)
- Результаты: ФИО, дата, возраст, адрес
- Количество найденных записей
- Клик по результату → переход на карточку человека

### 6. Ближайшие события

- Типы событий:
  - Дни рождения
  - Дни памяти (годовщины смерти)
  - Свадьбы / Никах
- Настраиваемый период (0–30 дней вперёд)
- Опция «Вчера» — включить/исключить вчерашние события
- Выбор даты через календарь
- Цветовая кодировка по типам:
  - Зелёный — дни рождения
  - Красный — дни памяти
  - Синий — свадьбы
- Цветовая кодировка по срокам: сегодня / вчера / завтра / скоро
- Расчёт количества лет (возраст / время с события)
- Клик по событию → переход на карточку человека

### 7. Проверка родства

- Выбор двух людей для анализа
- Поиск общего предка («аксакал»)
- Отображение фотографий общего предка
- Визуализация двух ветвей (линий связи):
  - Ветвь A — линия первого человека
  - Ветвь B — линия второго человека
- Цветовая кодировка ветвей
- Обнаружение прямого родства (предок/потомок)

### 8. Близкие родственники

- Иерархический список ближайших родственников:
  - Я
  - Родители (Папа / Мама)
  - Братья / Сёстры
  - Дети (Сын / Дочь)
  - Внуки (Внук / Внучка)
  - Правнуки (Правнук / Правнучка)
- Гендерно-зависимые названия
- Возраст для каждого родственника
- Клик → переход на карточку

### 9. Избранное

- 12 слотов для быстрого доступа к часто просматриваемым людям
- Добавление/удаление через звёздочку на карточке

### 10. Статистика и валидация данных (скрытый экран)

Доступ: долгое нажатие на настройки

**Статистика:**
- Количество мужчин / женщин
- Количество живых / умерших
- Распределение по возрастам (50–60, 60–70, 70–80, 80–90, 90–100, 100–110, 110+)
- Списки долгожителей (старше 90 лет)

**Валидация данных:**
- Проверка взаимности связей супругов (муж↔жена)
- Проверка связей родитель-ребёнок
- Обнаружение пустых имён/фамилий
- Обнаружение неизвестных людей (с «?»)
- Обнаружение «сирот» (без связей)
- Проверка корректности формата дат
- Проверка наличия фотографий

### 11. Настройки

- Выбор стартового экрана: сплеш / древо / события
- Период отображения событий (0–30 дней, кнопки +/-)
- Включение/отключение вчерашних событий
- Режим зелёных кнопок (20 последних vs все записи)
- Сброс и обновление базы данных (удаление + переимпорт из CSV)
- Тёмная тема (values-night)
- Поддержка русского и английского языков

## Модель данных

### Человек (Person)
| Поле | Описание |
|------|----------|
| id | Уникальный идентификатор |
| sex | Пол (0 — женский, 1 — мужской) |
| first_name | Имя |
| last_name | Фамилия |
| address | Адрес проживания |
| birth_day | Дата рождения (dd.MM.yyyy) |
| birth_place | Место рождения |
| dead_day | Дата смерти (пусто если жив) |
| dead_place | Место смерти |
| order_by_dad | Порядок рождения от отца |
| order_by_mom | Порядок рождения от матери |
| order_by_spouse | Порядок среди супругов |
| marry_day | Дата свадьбы / никаха |

### Связи
- **Spouse** (супруги): person_id ↔ spouse_id (связь многие-ко-многим)
- **Child** (родитель-ребёнок): person_id (родитель) → child_id (ребёнок)
- **Favorite** (избранное): 12 слотов, каждый хранит ID человека

### Фотографии
- Формат имени файла: `{person_id}#{photo_index}.jpg` (например, `42#0.jpg`, `42#1.jpg`)
- Фото по умолчанию: `m.jpg` (мужчина), `w.jpg` (женщина)
- Несколько фотографий на человека

### Биографии
- Открытые: файлы `open#{person_id}` (текстовые)
- Закрытые: файлы `lock#{person_id}` (доступ по паролю)

## Данные

- Источник данных: CSV-файлы (`fam.csv`, `fav.csv`) с разделителем «;»
- Импорт при первом запуске
- Возможность полного сброса и переимпорта

## Веб-приложение — Архитектура

### Общая схема

```
                        Пользователь (браузер)
                               │
                               ▼
                     ┌─────────────────────┐
                     │    API Gateway       │
                     │  (единая точка входа,│
                     │   авто-домен *.apigw │
                     │   .yandexcloud.net)  │
                     └────┬───────────┬─────┘
                          │           │
               /*  (статика)     /api/* (логика)
                          │           │
                          ▼           ▼
               ┌────────────────┐  ┌──────────────────────┐
               │ Object Storage │  │   Cloud Functions     │
               │  (SPA-бакет)   │  │   (Node.js 18)        │
               │  HTML/JS/CSS   │  │                        │
               └────────────────┘  │  Монтированный бакет:  │
                                   │  /mnt/media/ ← Object  │
                                   │  Storage (фото, bio)   │
                                   └──────────┬─────────────┘
                                              │
                                              ▼
                                   ┌─────────────────────┐
                                   │   YDB Serverless     │
                                   │  (persons, spouses,  │
                                   │   children, users,   │
                                   │   favorites, config)  │
                                   └─────────────────────┘
```

### Сервисы Yandex Cloud

| Сервис | Назначение |
|--------|-----------|
| **API Gateway** | Единая точка входа, маршрутизация: статика → Object Storage, API → Cloud Functions. Автоматический домен `*.apigw.yandexcloud.net` |
| **Object Storage** | Два бакета: (1) SPA-фронтенд (HTML/JS/CSS), (2) медиафайлы (фото, биографии) |
| **Cloud Functions** | Бэкенд-логика (Node.js 18). Медиа-бакет монтируется как `/mnt/media/` — прямой доступ к файлам через `fs` без SDK |
| **YDB Serverless** | Основная БД: люди, связи, пользователи, роли, настройки приложения |
| **Container Registry** | Не используется (функции деплоятся из zip-архивов) |

### Монтирование бакета в Cloud Functions

Медиа-бакет (фотографии, биографии) монтируется в Cloud Functions как файловая система:
- Путь: `/mnt/media/`
- Чтение фото: `fs.readFile('/mnt/media/photos/42#0.jpg')`
- Чтение биографий: `fs.readFile('/mnt/media/info/open#42')`
- Преимущества: простой код, нет зависимости от S3 SDK, быстрый доступ
- Запись (загрузка новых фото через админку) — через тот же `fs.writeFile`

### Фронтенд

- **React 19** + **Next.js** (static export, `output: 'export'`)
- **Tailwind CSS 4** — адаптивный дизайн (mobile-first)
- **shadcn/ui** — компоненты (карточки, диалоги, навигация, таблицы)
- **Современный дизайн** — не привязан к Android-приложению
- **Адаптивность** — корректное отображение на телефоне, планшете и десктопе

### Бэкенд (Cloud Functions)

Набор функций за API Gateway:

| Функция | Маршрут | Описание |
|---------|---------|----------|
| `persons` | `GET /api/persons/:id` | Карточка человека с родственниками |
| `search` | `GET /api/search?q=...` | Полнотекстовый поиск |
| `events` | `GET /api/events?days=N` | Ближайшие события |
| `tree` | `GET /api/tree/:id` | Дерево поколений |
| `kinship` | `GET /api/kinship?id1=..&id2=..` | Проверка родства |
| `family` | `GET /api/family/:id` | Близкие родственники |
| `stats` | `GET /api/stats` | Статистика |
| `media` | `GET /api/media/:filename` | Фото/файл из монтированного бакета |
| `auth` | `POST /api/auth/login` | Аутентификация |
| `admin/*` | `*/api/admin/*` | CRUD-операции админки |

### Аутентификация и роли

Три роли с разными правами доступа:

| Возможность | Админ | Менеджер | Просмотр |
|-------------|-------|----------|----------|
| Просмотр древа, поиск, события | + | + | + |
| Редактирование людей (CRUD) | + | + | - |
| Загрузка/удаление фотографий | + | + | - |
| Редактирование биографий | + | + | - |
| Управление пользователями | + | - | - |
| Настройки приложения | + | - | - |
| Импорт/экспорт данных | + | - | - |
| Валидация данных | + | + | - |

Реализация:
- JWT-токены (выдаются при логине)
- Хранение пользователей и ролей в YDB
- Middleware проверки токена в каждой Cloud Function
- Хеширование паролей (bcrypt)
- Публичные маршруты (древо, поиск, события) — без авторизации
- Админские маршруты (`/api/admin/*`) — только с валидным JWT и подходящей ролью

### Админская зона

**Управление людьми:**
- Список всех людей с фильтрацией и сортировкой
- Создание / редактирование / удаление записей
- Редактирование связей (родители, супруги, дети)
- Загрузка и управление фотографиями (drag & drop)
- Редактирование биографий (открытых и закрытых)

**Управление пользователями (только Админ):**
- Создание пользователей с назначением роли
- Изменение ролей
- Блокировка / удаление пользователей

**Настройки приложения (только Админ):**
- Название приложения, описание
- Ссылка на Telegram-канал
- Период событий по умолчанию
- Стартовая страница по умолчанию
- Тексты «О приложении» и «Информация»

**Данные (только Админ):**
- Импорт из CSV
- Экспорт в CSV
- Валидация целостности данных (как в FamTestActivity)
- Просмотр статистики

### CI/CD

```
GitHub Actions Pipeline
│
├── on push to main:
│   ├── [lint + typecheck] ─── параллельно
│   ├── [build frontend]
│   │   └── next build && next export
│   │   └── yc storage cp → SPA-бакет
│   ├── [deploy functions]
│   │   └── zip каждой функции
│   │   └── yc serverless function version create (для каждой)
│   └── [update API Gateway]
│       └── yc api-gateway update --spec gateway.yaml
│
├── on pull request:
│   └── lint + typecheck + build (проверка)
│
└── Terraform (инфраструктура):
    └── terraform apply (бакеты, функции, YDB, API Gateway, IAM)
```

**Zero downtime:** каждый деплой создаёт новую версию функции — переключение мгновенное, старая версия продолжает обслуживать текущие запросы.

### Инфраструктура как код (Terraform)

Все ресурсы описываются в Terraform:
- Object Storage бакеты (SPA + медиа)
- Cloud Functions (все функции)
- API Gateway (спецификация OpenAPI)
- YDB Serverless (база + таблицы)
- IAM (сервисные аккаунты и права)

### Модель данных (YDB)

Расширение базовой модели для веб-версии:

**Существующие таблицы (миграция из CSV):**
- `persons` — люди
- `spouses` — связи супругов
- `children` — связи родитель-ребёнок

**Новые таблицы:**
- `users` — пользователи админки (id, login, password_hash, role, created_at)
- `favorites` — избранное (user_id, person_id)
- `app_config` — настройки приложения (key, value)
- `sessions` — JWT refresh-токены (user_id, token, expires_at)

## Технический стек (Android)

- Kotlin
- Room (SQLite ORM), база данных `person3.db`
- DataStore (настройки)
- Joda-Time (расчёт дат и возрастов)
- Picasso + Glide (загрузка изображений)
- Lottie (анимации)
- FlexboxLayout (дерево поколений)
- ImageSlideshow (карусель фото)
- Min SDK 23 (Android 6.0), Target SDK 31 (Android 12)

## Технический стек (Веб)

- **Frontend:** React 19, Next.js (static export), Tailwind CSS 4, shadcn/ui
- **Backend:** Node.js 18, Yandex Cloud Functions
- **API:** Yandex API Gateway (OpenAPI 3.0)
- **БД:** YDB Serverless
- **Хранилище:** Yandex Object Storage (2 бакета: SPA + медиа)
- **Монтирование:** медиа-бакет → `/mnt/media/` в Cloud Functions
- **IaC:** Terraform (Yandex Cloud Provider)
- **CI/CD:** GitHub Actions
- **Аутентификация:** JWT (bcrypt, refresh tokens)

## Структура проекта

```
drevo/
  PROJECT.md              — описание проекта и функциональности
  android-app/            — существующая реализация Android-приложения (Kotlin)
  web-app/                — веб-приложение
    frontend/             — Next.js SPA
      src/
        app/              — страницы (App Router)
        components/       — React-компоненты
        lib/              — утилиты, API-клиент
      public/             — статические ресурсы
    functions/            — Cloud Functions (бэкенд)
      persons/            — функция: карточка человека
      search/             — функция: поиск
      events/             — функция: события
      tree/               — функция: дерево поколений
      kinship/            — функция: проверка родства
      family/             — функция: близкие родственники
      stats/              — функция: статистика
      media/              — функция: медиафайлы
      auth/               — функция: аутентификация
      admin/              — функция: CRUD админки
      shared/             — общий код (YDB-клиент, JWT, миддлвары)
    infra/                — Terraform-конфигурация
      main.tf             — основные ресурсы
      variables.tf        — переменные
      gateway.yaml        — OpenAPI-спецификация API Gateway
    .github/
      workflows/
        deploy.yml        — CI/CD pipeline
    package.json          — зависимости и скрипты
```
