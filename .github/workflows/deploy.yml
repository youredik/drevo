name: Deploy Drevo

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
  YC_SA_KEY: ${{ secrets.YC_SA_KEY }}

jobs:
  lint-and-typecheck:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: web-app/frontend/package-lock.json

      - name: Install frontend deps
        working-directory: web-app/frontend
        run: npm ci

      - name: Lint
        working-directory: web-app/frontend
        run: npx eslint .

      - name: Typecheck
        working-directory: web-app/frontend
        run: npx tsc --noEmit

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: web-app/frontend/package-lock.json

      - name: Install deps
        working-directory: web-app/frontend
        run: npm ci

      - name: Build
        working-directory: web-app/frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ""

      - name: Upload SPA to Object Storage
        uses: yc-actions/yc-obj-storage-upload@v2
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SA_KEY }}
          bucket: drevo-spa
          root: web-app/frontend/out
          clear: true

  deploy-functions:
    name: Deploy Cloud Functions
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: web-app/functions/package-lock.json

      - name: Install deps
        working-directory: web-app/functions
        run: npm ci

      - name: Build functions
        working-directory: web-app/functions
        run: npm run build

      - name: Package function
        working-directory: web-app/functions
        run: |
          mkdir -p dist
          cd dist && zip -r api.zip ../handler.js ../shared/ ../node_modules/ ../package.json

      - name: Deploy function
        uses: yc-actions/yc-sls-function@v3
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SA_KEY }}
          function-name: drevo-api
          runtime: nodejs18
          memory: 256mb
          execution-timeout: 10s
          entrypoint: handler.handler
          source: web-app/functions/dist/api.zip
          environment: |
            JWT_SECRET=${{ secrets.JWT_SECRET }}

  update-gateway:
    name: Update API Gateway
    runs-on: ubuntu-latest
    needs: [build-frontend, deploy-functions]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Install YC CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure YC CLI
        run: |
          echo '${{ secrets.YC_SA_KEY }}' > sa-key.json
          yc config set service-account-key sa-key.json
          yc config set folder-id ${{ secrets.YC_FOLDER_ID }}

      - name: Update API Gateway spec
        run: |
          yc serverless api-gateway update drevo-gateway \
            --spec web-app/infra/gateway.yaml
