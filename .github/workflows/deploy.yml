name: Deploy Drevo

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: "20"
  FUNCTION_NAME: drevo-api
  SPA_BUCKET: drevo-spa
  MEDIA_BUCKET: drevo-media

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # ─── Build backend ───────────────────────────────────
      - name: Install backend deps
        working-directory: web-app/functions
        run: npm ci

      - name: Typecheck backend
        working-directory: web-app/functions
        run: npx tsc --noEmit

      - name: Build backend
        working-directory: web-app/functions
        run: npm run build

      # ─── Build frontend ──────────────────────────────────
      - name: Install frontend deps
        working-directory: web-app/frontend
        run: npm ci

      - name: Build frontend
        working-directory: web-app/frontend
        run: npx next build
        env:
          NEXT_PUBLIC_API_URL: ""

      # ─── Install YC CLI ──────────────────────────────────
      - name: Install Yandex Cloud CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          echo "$HOME/yandex-cloud/bin" >> $GITHUB_PATH

      - name: Configure YC CLI
        run: |
          echo '${{ secrets.YC_SA_KEY }}' > /tmp/sa-key.json
          yc config set service-account-key /tmp/sa-key.json
          yc config set folder-id ${{ secrets.YC_FOLDER_ID }}

      # ─── Deploy Cloud Function ───────────────────────────
      - name: Get YDB info
        id: ydb
        run: |
          YDB_INFO=$(yc ydb database get drevo-db --format json)
          FULL_ENDPOINT=$(echo $YDB_INFO | jq -r '.endpoint')
          ENDPOINT=$(echo "$FULL_ENDPOINT" | cut -d'?' -f1 | sed 's|/$||')
          echo "endpoint=$ENDPOINT" >> $GITHUB_OUTPUT
          DATABASE=$(echo "$FULL_ENDPOINT" | sed 's/.*database=\(.*\)/\1/')
          echo "database=$DATABASE" >> $GITHUB_OUTPUT

      - name: Get Service Account ID
        id: sa
        run: |
          SA_ID=$(yc iam service-account get drevo-sa --format json | jq -r '.id')
          echo "id=$SA_ID" >> $GITHUB_OUTPUT

      - name: Upload function package to S3
        run: |
          yc storage s3api put-object \
            --bucket=${{ env.MEDIA_BUCKET }} \
            --key=deploy/api.zip \
            --body=web-app/functions/dist/api.zip

      - name: Deploy Cloud Function
        run: |
          yc serverless function version create \
            --function-name=${{ env.FUNCTION_NAME }} \
            --runtime=nodejs22 \
            --entrypoint=handler.handler \
            --memory=256m \
            --execution-timeout=10s \
            --package-bucket-name=${{ env.MEDIA_BUCKET }} \
            --package-object-name=deploy/api.zip \
            --service-account-id=${{ steps.sa.outputs.id }} \
            --environment="JWT_SECRET=${{ secrets.JWT_SECRET }},YDB_ENDPOINT=${{ steps.ydb.outputs.endpoint }},YDB_DATABASE=${{ steps.ydb.outputs.database }},MEDIA_MOUNT=/mnt/media" \
            --storage-mounts="mount-point=media,bucket=${{ env.MEDIA_BUCKET }},prefix=,read-only=false"

      # ─── Deploy SPA to Object Storage ────────────────────
      - name: Upload SPA
        uses: yc-actions/yc-obj-storage-upload@v2
        with:
          yc-sa-json-credentials: ${{ secrets.YC_SA_KEY }}
          bucket: ${{ env.SPA_BUCKET }}
          root: web-app/frontend/out
          clear: true

      # ─── Cleanup ─────────────────────────────────────────
      - name: Cleanup
        if: always()
        run: rm -f /tmp/sa-key.json
